<!DOCTYPE html>
<html lang="zh-tw">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Jimmy Lin">
<meta name="description" content="Things that I learned">
<meta name="generator" content="Hugo 0.30.2" />
<title>使用 CircleCI 部署 Hugo 靜態網站</title>
<link rel="shortcut icon" href="https://jimmylin212.github.io/images/favicon.ico">
<link rel="stylesheet" href="https://jimmylin212.github.io/css/style.css">
<link rel="stylesheet" href="https://jimmylin212.github.io/css/highlight.css">



<link rel="stylesheet" href="https://jimmylin212.github.io/css/monosocialiconsfont.css">



<link href="https://jimmylin212.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Jimmy Lin" />


<meta property="og:title" content="使用 CircleCI 部署 Hugo 靜態網站" />
<meta property="og:description" content="搞了半天，終於可以利用 CircleCI 來部署 Hugo 靜態網站到 Github Page，這當中出現出現非常多的錯誤，累積失敗的 Build 高達七十個，把這些錯誤的例子都寫寫，以後如果有" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jimmylin212.github.io/post/0003_deploy_hugo_using_circleci/" />



<meta property="article:published_time" content="2017-12-09T09:51:03&#43;08:00"/>

<meta property="article:modified_time" content="2017-12-09T09:51:03&#43;08:00"/>













<meta itemprop="name" content="使用 CircleCI 部署 Hugo 靜態網站">
<meta itemprop="description" content="搞了半天，終於可以利用 CircleCI 來部署 Hugo 靜態網站到 Github Page，這當中出現出現非常多的錯誤，累積失敗的 Build 高達七十個，把這些錯誤的例子都寫寫，以後如果有">


<meta itemprop="datePublished" content="2017-12-09T09:51:03&#43;08:00" />
<meta itemprop="dateModified" content="2017-12-09T09:51:03&#43;08:00" />
<meta itemprop="wordCount" content="2108">



<meta itemprop="keywords" content="Hugo," />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="使用 CircleCI 部署 Hugo 靜態網站"/>
<meta name="twitter:description" content="搞了半天，終於可以利用 CircleCI 來部署 Hugo 靜態網站到 Github Page，這當中出現出現非常多的錯誤，累積失敗的 Build 高達七十個，把這些錯誤的例子都寫寫，以後如果有"/>


    </head>
<body>
    <nav class="main-nav">
	
		<a href='https://jimmylin212.github.io'> <span class="arrow">←</span>Home</a>
	

	
 		<a href='/about/'>About</a>
  	

	
		<a class="cta" href="https://jimmylin212.github.io/index.xml">Subscribe</a>
	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>使用 CircleCI 部署 Hugo 靜態網站</h1>
        <h2 class="subtitle"></h2>
        <h2 class="headline">
        December 9, 2017
        <br>
        
        
            
                <a href="https://jimmylin212.github.io/tags/hugo">Hugo</a>
            
        
        
        </h2>
    </header>
    <section id="post-body">
        

<p>搞了半天，終於可以利用 CircleCI 來部署 Hugo 靜態網站到 Github Page，這當中出現出現非常多的錯誤，累積失敗的 Build 高達七十個，把這些錯誤的例子都寫寫，以後如果有人看到或是自己想要重新 Reference 都比較方便。</p>

<p>因為沒有裝 CircleCI CLI，很多 commit 都只改一行 <code>config.yaml</code>，還是建議可以裝一下 CLI，才不會紅紅一片看了不爽快，我遇到的錯誤如下：</p>

<ul>
<li>在 CircleCI 上面沒辦法正常產生靜態網站，錯誤訊息: <code>nothing to commit, working directory clean</code></li>
<li>同樣的 commit，但是卻出現重複的 build，一個成功，一個失敗</li>
<li>嘗試採用 CircleCI 2.0 的 workflow，不過無法成功部署</li>
<li>嘗試用 CircleCI 2.0 workflow 中的 filter，屢次失敗</li>
<li>Github 認證沒有過，無法 push 到 submodule 當中</li>
<li>因為版本不對沒有辦法 push 到 submodule</li>
<li>&hellip;</li>
</ul>

<p>因為要從 CircleCI 部署網站，撰寫文章的流程需要有所修改，我目前覺得最舒服而且相對比較簡單的方式如下：</p>

<ol>
<li>開另外一個 branch，取名叫做 develop，所有文章撰寫，或是對針對主題、版面的修改，都在這個 branch 上面完成，也都把所有的 changes 都 push 到這個 branch 當中。</li>
<li>改好之後，確定要發布了，直接從 Github 上操作，在 master branch 中，建立 Pull Request，從 branch develop merge 文章到 master branch；當然也可以利用 Github CLI，切換到 master branch，從 develop branch merge 到 master，再 push 上去。</li>
<li>這時候因為有寫 CircleCI 設定檔，Github 會把這個 merge 推送到 CircleCI，CircleCI 針對這個 commit 做一些檢查，如果沒有問題的話，會執行 <code>hugo</code> 指令，建立靜態網站，並且把 <code>public</code> 資料夾下的東西推送到 <code>&lt;your-account&gt;.github.io</code> repo，自動部署網站。</li>
</ol>

<p>那到底要怎麼完成呢？</p>

<h3 id="環境設定">環境設定</h3>

<p>我的環境如下：</p>

<ul>
<li>Hugo 文章都存在 repo <code>github_io_content</code> 中</li>
<li>Hugo 網站放在 repo <code>&lt;your-account.github.io&gt;</code> 中</li>
</ul>

<p>步驟如下：</p>

<ol>
<li>在 CircleCI 開帳號，並且設定好我們要 build 的 project 是 <code>github_io_content</code>，也就是你放所有的文章的那個 projecy，<strong>不是</strong> 你部署上去的那個。</li>
<li>其實 CircleCI 會自動建立 key，不過是 read only 的，所以我們要建立另外一把 key <a href="https://help.github.com/articles/connecting-to-github-with-ssh/">(建 key 教學)</a>，專門給 CircleCI 用的，讓環境乾淨一點，這把 key 要可讀可寫。</li>
<li>把這把 key 的 public key 加到 Github repo <code>&lt;your-account.github.io&gt;</code> 的 deploy key 中。<a href="https://circleci.com/docs/1.0/adding-read-write-deployment-key/">參考文件</a></li>
<li>把這把 key 的 private key 加到 CircleCI project <code>github_io_content</code> 中。<a href="https://circleci.com/docs/1.0/adding-read-write-deployment-key/">參考文件</a></li>
<li>寫 CircleCI 專屬的 <code>config.yaml</code> 檔於 <code>.circleci</code> 資料夾中，</li>
</ol>

<p>config.yaml 內容如下，下面有更詳細介紹。</p>

<pre><code>version: 2
global: &amp;global
  working_directory: ~/project
  docker:
    - image: felicianotech/docker-hugo:0.30.2

jobs:
  build_n_deploy:
    &lt;&lt;: *global
    steps:
      - checkout
      - run:
          name: &quot;Run Hugo&quot;
          command: |
            git submodule sync &amp;&amp; git submodule update --init 
            git submodule foreach --recursive git pull origin master
            HUGO_ENV=production hugo -v

      - add_ssh_keys:
          fingerprints:
            - &quot;44:4d:07:a8:35:...fingerprint_of_key&quot;
      - run:
          name: &quot;Deploy to github.io&quot;       
          command: |
            cd ~/project/public
            git config --global user.email &quot;you@email.com&quot;
            git config --global user.name &quot;First Last&quot;
            git add -A
            git commit -m &quot;Deploy from CircleCI&quot;
            git push origin HEAD:master

workflows:
  version: 2
  build-deploy:
    jobs:
      - build_n_deploy:
          filters:
            branches:
              only: master

</code></pre>

<h3 id="設定檔解釋">設定檔解釋</h3>

<p>設定檔是參考 <a href="https://circleci.com/blog/build-test-deploy-hugo-sites/">這個連結</a> 所完成的，另外有根據自己的經驗在 deploy 那邊做了些調整，那倒底改了什麼呢？新版的 CircleCI 裡面，使用了 Workflow 的概念，讓整個流程更加清楚。那就來一段一段解釋吧！</p>

<h5 id="第一段-全域變數設定">第一段 (全域變數設定)</h5>

<pre><code>version: 2
global: &amp;global
  working_directory: ~/project
  docker:
    - image: felicianotech/docker-hugo:0.30.2
</code></pre>

<p>這一區可以想像成定義全域的參數，這邊訂了兩個全域的變數 <code>working_directory</code> 以及 <code>docker</code>。<code>working_directory</code> 是定義要在哪一個資料夾執行下面的指令，<code>project</code> 並不是一個叫做 <code>project</code> 的資料夾，CircleCI 把專案的 root 資料夾視為 project。另外這邊我們使用一個第三方的 Docker，利用這個 Docker 可以成功地把 Hugo 在 CircleCI 的環境下跑起來。</p>

<h5 id="第三段-workflow-設定">第三段 (Workflow 設定)</h5>

<pre><code>workflows:
  version: 2
  build-deploy:
    jobs:
      - build_n_deploy:
          filters:
            branches:
              only: master
</code></pre>

<p>這段我們定義 workflow 要怎麼執行，要執行那些 jobs，有沒有一些 filter 的條件或是有沒有其他 dependent 的 job。在這邊，定義了一個 workflow，叫做 <code>build-deploy</code>，這個 workflow 只有一個 job 要跑，job 名稱叫做 <code>build_n_deploy</code>。另外在這個 job 上加上了執行條件，條件用 <code>filters</code> 來設定，可以使用的變數有 <code>branches</code> 以及 <code>tags</code>，看是要在特定的 branch/tag 才執行或不執行 job。這邊寫的是，只有 branch master 才行執行這個 job，其他的 branch 都不會執行。還記得前面流程的部分嗎？我們把一般的編輯或是草稿都只丟到 branch develop 裡面，只有真的要 release 的時候，才推送到 master 上。所以根據這段設定，也只有推送到 master
才會部屬到 <code>&lt;your-account.github.io&gt;</code> 中。</p>

<h5 id="第二段-jobs-設定">第二段 (jobs 設定)</h5>

<p>最後我們來看中間的 <code>jobs</code> 這段，這段可以分成兩小段:
1. Build 以及執行 Hugo 指令
2. 部署到 <code>&lt;your-account&gt;.github.io</code></p>

<p><strong>Build 以及執行 Hugo 指令</strong></p>

<pre><code>jobs:
  build_n_deploy:
    &lt;&lt;: *global
    steps:
      - checkout
      - run:
          name: &quot;Run Hugo&quot;
          command: |
            git submodule sync &amp;&amp; git submodule update --init 
            git submodule foreach --recursive git pull origin master
            HUGO_ENV=production hugo -v
</code></pre>

<p>這段我們先定義了一個名子叫做 &ldquo;build_n_deploy&rdquo; 的 job，然後藉由 <code>&lt;&lt;: *global</code> 把前面第一所定義的內容抓回來。之後執行 <code>checkout</code> 會幫忙檢查一些有的沒的，再來就是 Hugo 相關的主要指令了。首先 <code>git submodule sync &amp;&amp; git submodule update --init</code> 初始化 git submodule，這邊應該可以看到兩個 submodule，一個是資料夾 public，就是你部署的網站 <code>&lt;your-account&gt;.github.io</code>；另外一個是我們所使用的 theme。再來執行 <code>git submodule foreach --recursive git pull origin master</code>，把 submodule 都更新到最新的版本，以免之後 push 發生版本不相符的問題。最後執行 <code>HUGO_ENV=production hugo -v</code>，在 CircleCI 的環境底下把網站跑起來，點進去看 CircleCI 的網頁，應該可以看到如下圖的訊息，跟你自己在本機端跑起來應該要是一模一樣的。</p>

<p><img src="/images/0003/hugo_server.JPG" alt="" /></p>

<p><strong>部署到 <code>&lt;your-account&gt;.github.io</code></strong></p>

<pre><code>      - add_ssh_keys:
          fingerprints:
            - &quot;44:4d:07:a8:35:...fingerprint_of_key&quot;
      - run:
          name: &quot;Deploy to github.io&quot;       
          command: |
            cd ~/project/public
            git config --global user.email &quot;you@email.com&quot;
            git config --global user.name &quot;First Last&quot;
            git add -A
            git commit -m &quot;Deploy from CircleCI&quot;
            git push origin HEAD:master
</code></pre>

<p>最一開始我們先把 sshkey 加進去，之後才有辦法部署成功。再來就是重頭戲了。首先我們先進去剛剛成功建立起來的網站的資料夾，<code>cd ~/project/public</code>，進入這個資料夾之後，也等於我們進入了 project <code>&lt;your-account&gt;.github.io</code> 的 git 環境了。再來利用 <code>git config</code> 做一些基本的設定。然後 <code>git add -A</code> 把所有改變都加入 commit。利用 <code>git commit -m &quot;&quot;</code> 寫一下 commit 的訊息。最後 push 到 branch master 的 HEAD 就大功告成了。如果大功告成應該會有下面截圖的訊息。</p>

<p><img src="/images/0003/git_deploy.JPG" alt="" /></p>

<p>如果有問題的話就在下面發問吧，有看到都會回。</p>

    </section>
</article>

<footer id="post-meta" class="clearfix">
    
    <img class="avatar" src="https://jimmylin212.github.io/images/avatar.png">
    <div>
        <span class="dark">Jimmy Lin</span>
        <span>Programmer - Diver - Blogger</span>
    </div>
    
    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fjimmylin212.github.io%2fpost%2f0003_deploy_hugo_using_circleci%2f - %e4%bd%bf%e7%94%a8%20CircleCI%20%e9%83%a8%e7%bd%b2%20Hugo%20%e9%9d%9c%e6%85%8b%e7%b6%b2%e7%ab%99 "><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

    </section>
</footer>

<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jimmylin212-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="/post/0002_hugo_content_management_dir_structure/">Hugo 的文件管理 - 資料夾結構<aside class="dates">Dec 5 2017</aside></a>
        </li>
    
        <li>
            <a href="/post/0001_create_hugo_and_deploy_on-github_page/">使用 Hugo 建立靜態網站，並部署在 Github Page<aside class="dates">Nov 27 2017</aside></a>
        </li>
    
</ul>



        <footer id="footer">
    
        <div id="social">

	
	
    
    <a class="symbol" href="https://www.facebook.com/jimmylin212">
        circlefacebook
    </a>
    
    <a class="symbol" href="https://www.github.com/jimmylin212">
        circlegithubalt
    </a>
    
    <a class="symbol" href="https://www.linkedin.com/in/jimmylin212/">
        circlelinkedin
    </a>
    
    <a class="symbol" href="https://stackoverflow.com/story/jimmylin212">
        circlestackoverflow
    </a>
    


</div>

    
    <p class="small">
    
        © Copyright 2018 Jimmy Lin
    
    </p>
</footer>

    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://jimmylin212.github.io/js/main.js"></script>
<script src="https://jimmylin212.github.io/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-2756751-14', 'auto');
ga('send', 'pageview');
</script>


</body>
</html>
